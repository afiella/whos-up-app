<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkEKUzUhc-nKFLnF1w0MOm6qwpKHTpfaI",
    authDomain: "who-s-up-app.firebaseapp.com",
    databaseURL: "https://who-s-up-app-default-rtdb.firebaseio.com",
    projectId: "who-s-up-app",
    storageBucket: "who-s-up-app.appspot.com",
    messagingSenderId: "167292375113",
    appId: "1:167292375113:web:ce718a1aab4852fe5daf98"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  let currentRoom = null;
  let draggedIndex = null;
  let playerKeys = [];

  window.checkPassword = function () {
    const input = document.getElementById("adminPassword").value.trim();
    if (input === "afia") {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("adminPanel").classList.remove("hidden");
    } else {
      alert("Incorrect password");
    }
  };

  window.loadRoom = function (room) {
    currentRoom = room;
    document.getElementById("roomTitle").textContent = `Room: ${room}`;
    const playersRef = ref(db, `rooms/${room}/players`);
    onValue(playersRef, (snapshot) => {
      const data = snapshot.val() || {};
      const playerList = document.getElementById("playerList");
      playerList.innerHTML = "";

      playerKeys = Object.entries(data)
        .filter(([_, p]) => p.inRotation !== false)
        .sort((a, b) => a[1].joinedAt - b[1].joinedAt);

      playerKeys.forEach(([key, player], index) => {
        const div = document.createElement("div");
        div.className = "flex items-center justify-between bg-white p-3 rounded shadow cursor-move";
        div.setAttribute("draggable", true);
        div.dataset.index = index;

        div.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full" style="background:${player.color}"></div>
            <span class="font-semibold">${player.name}</span>
          </div>
          <div class="flex gap-2">
            <button onclick="removePlayer('${room}', '${key}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Remove</button>
            <button onclick="skipPlayer('${room}', '${key}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm">Skip</button>
          </div>
        `;

        // Drag events
        div.addEventListener("dragstart", (e) => {
          draggedIndex = parseInt(div.dataset.index);
        });

        div.addEventListener("dragover", (e) => {
          e.preventDefault();
          div.classList.add("ring", "ring-blue-300");
        });

        div.addEventListener("dragleave", () => {
          div.classList.remove("ring", "ring-blue-300");
        });

        div.addEventListener("drop", () => {
          const targetIndex = parseInt(div.dataset.index);
          reorderPlayers(draggedIndex, targetIndex);
        });

        playerList.appendChild(div);
      });
    });
  };

  function reorderPlayers(fromIndex, toIndex) {
    if (fromIndex === toIndex) return;

    const moved = playerKeys.splice(fromIndex, 1)[0];
    playerKeys.splice(toIndex, 0, moved);

    const updates = {};
    playerKeys.forEach(([key], i) => {
      updates[`rooms/${currentRoom}/players/${key}/joinedAt`] = Date.now() + i;
    });

    update(ref(db), updates);
  }

  window.removePlayer = (room, key) => {
    const playerRef = ref(db, `rooms/${room}/players/${key}`);
    remove(playerRef);
  };

  window.skipPlayer = (room, key) => {
    const playerRef = ref(db, `rooms/${room}/players/${key}`);
    update(playerRef, { skip: true });
  };
</script>