<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Who's Up App</title>
  <script src="https://cdn.tailwindcss.com">});
</script>
  <script>

    <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js"></script>

    const firebaseConfig = {
      apiKey: "AIzaSyDkEKUzUhc-nKFLnF1w0MOm6qwpKHTpfaI",
      authDomain: "who-s-up-app.firebaseapp.com",
      databaseURL: "https://who-s-up-app-default-rtdb.firebaseio.com",
      projectId: "who-s-up-app",
      storageBucket: "who-s-up-app.appspot.com",
      messagingSenderId: "167292375113",
      appId: "1:167292375113:web:ce718a1aab4852fe5daf98",
      measurementId: "G-NPK2KV2CXY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const playersRef = ref(db, 'players');

    const loginScreen = document.getElementById("loginScreen");
    const adminLoginScreen = document.getElementById("adminLoginScreen");
    const roleSelectScreen = document.getElementById("roleSelectScreen");
    const mainApp = document.getElementById("mainApp");
    const playersDiv = document.getElementById("players");
    const outPlayersDiv = document.getElementById("outPlayers");
    const currentNextUpSpan = document.getElementById("currentNextUp");

    const allColors = ["#fca5a5", "#fdba74", "#fde68a", "#bbf7d0", "#bfdbfe", "#ddd6fe"];
    let loggedInUser = JSON.parse(localStorage.getItem("currentUser")) || null;

    document.getElementById("playerRoleBtn").addEventListener("click", () => {
      roleSelectScreen.classList.add("hidden");
      loginScreen.classList.remove("hidden");
    });

    
      
    });

    
  } else {
    alert("Incorrect admin password.");
  }
});

document.getElementById("loginBtn").addEventListener("click", () => {
  const nameInput = document.getElementById("loginName").value.trim();
  const color = document.getElementById("loginColor").value;

  if (!nameInput || !color) {
    alert("Please enter your name and select a color.");
    return;
  }

  const capitalized = nameInput.charAt(0).toUpperCase() + nameInput.slice(1);
  const newPlayer = { name: capitalized, color: color, active: true, skip: false };

  set(ref(db, `players/${capitalized}`), newPlayer);
  loggedInUser = newPlayer;
  localStorage.setItem("currentUser", JSON.stringify(newPlayer));

  loginScreen.classList.add("hidden");
  mainApp.classList.remove("hidden");
  document.getElementById("selfToggle").classList.remove("hidden");

  const emoji = ['tia', 'veronica', 'ella'].includes(capitalized.toLowerCase()) ? '♡' : '!';
  const welcome = document.createElement("div");
  welcome.className = "text-lg font-semibold text-green-700 mb-2";
  welcome.textContent = `Welcome, ${capitalized} ${emoji}`;
  document.getElementById("mainApp").prepend(welcome);

  

  onValue(playersRef, (snapshot) => {
    const playersData = snapshot.val();
    updateDisplay(playersData);
  });
});
    
    mainApp.classList.remove("hidden");
if (!loggedInUser.role) {
  document.getElementById("selfToggle").classList.remove("hidden");
  const nextUpBtn = document.querySelector("button[onclick='nextUp()']");
  if (nextUpBtn) nextUpBtn.classList.add("hidden");

  const name = loggedInUser.name?.toLowerCase();
  const emoji = ['tia', 'veronica', 'ella'].includes(name) ? '♡' : '!';
  const welcome = document.createElement("div");
  welcome.className = "text-lg font-semibold text-green-700 mb-2";
  welcome.textContent = `Welcome, ${loggedInUser.name} ${emoji}`;
  document.getElementById("mainApp").prepend(welcome);
}
onValue(playersRef, (snapshot) => {
  const playersData = snapshot.val();
  updateDisplay(playersData);
});
    function setRotationStatus(status) {
      const userRef = ref(db, `players/${loggedInUser.name}`);
      if (status === 'in') {
        update(userRef, { active: true, skip: false });
      } else if (status === 'out') {
        update(userRef, { active: false, skip: false });
      } else if (status === 'skip') {
        update(userRef, { skip: true });
      }
    }

    function nextUp() {
      onValue(playersRef, (snapshot) => {
        const all = Object.values(snapshot.val() || {});
        const players = all.filter(p => p.active && !p.skip);
        if (players.length > 0) {
          const first = players.shift();
          players.push(first);
          const updates = {};
          players.forEach(p => updates[`players/${p.name}`] = { ...p, skip: false });
          update(ref(db), updates);
        }
      }, { onlyOnce: true });
    }

    onValue(playersRef, (snapshot) => {
      const playersData = snapshot.val();
      updateDisplay(playersData);
    });

    function updateDisplay(playersObj) {
      const players = Object.values(playersObj || {}).filter(p => p.active);
      const nextPlayer = players[0]?.name || null;
      const outPlayers = Object.values(playersObj || {}).filter(p => !p.active);
      playersDiv.innerHTML = "";

      // Only show queue to admin
      if (loggedInUser?.name) {
        const pos = players.findIndex(p => p.name === loggedInUser.name);
        const container = document.createElement("div");
        container.className = "text-sm text-gray-700";
        if (pos !== -1) {
  const turnText = pos === 0 ? "You're up next!" : `You’re up in ${pos} turn(s)`;
  container.innerHTML = `<p class="font-medium">${turnText}</p>`;
}`;
        } else {
          container.innerHTML = `<p class="text-red-500 font-medium">You are currently out of rotation.</p>`;
        }
        playersDiv.appendChild(container);
      }

      currentNextUpSpan.textContent = nextPlayer || "No one";

      // Highlight the "Next" text if it's your turn
      if (loggedInUser?.name && !loggedInUser.role) {
        const isUp = loggedInUser.name === nextPlayer;
        const nextBox = document.getElementById("currentNextUpBox");
        nextBox.style.borderColor = isUp ? "#22c55e" : "#d1d5db";
        nextBox.classList.remove("animate-pop");
        if (isUp) {
          void nextBox.offsetWidth; // force reflow for animation
          nextBox.classList.add("animate-pop");
        }
      }

      // Also update the selfToggle display if user is a player
      if (loggedInUser?.name && !loggedInUser.role) {
        const isUp = loggedInUser.name === nextPlayer;
        document.getElementById("currentNextUpBox").style.borderColor = isUp ? "#22c55e" : "#d1d5db";
      }

      outPlayersDiv.innerHTML = "";
      outPlayers.forEach(player => {
        const div = document.createElement("div");
        div.className = "flex items-center space-x-4 p-2 rounded";
        div.style.backgroundColor = player.color;
        div.innerHTML = `
          <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color: ${player.color}">
            ${player.name.charAt(0)}
          </div>
          <span>${player.name}</span>
        `;
        outPlayersDiv.appendChild(div);
      });
    }
  </script>

  <style>
    @keyframes slideLeft {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(-100%); opacity: 0; }
    }
    @keyframes slideIn {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    .slide-out {
      animation: slideLeft 0.4s forwards;
    }
    .slide-in {
      animation: slideIn 0.4s forwards;
    }
    @media screen and (max-width: 640px) {
      .player {
        flex-direction: column;
        align-items: flex-start;
      }
      .player span {
        font-size: 0.875rem;
      }
    }
      @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
    .animate-pop {
      animation: pop 0.5s ease-in-out;
    }
</style>
</head>
<body class="bg-gray-100 flex justify-center items-start min-h-screen py-10">
  <!-- ROLE SELECT -->
  <div id="roleSelectScreen" class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-4">Who's Up App</h1>
    <button id="playerRoleBtn" class="bg-blue-500 text-white w-full py-2 rounded mb-2">Join as Player</button>
    
  </div>

  <!-- PLAYER LOGIN -->
  <div id="loginScreen" class="hidden bg-white p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-4">Join Who's Up</h1>
    <input id="loginName" type="text" placeholder="Your name" class="w-full p-2 border border-gray-300 rounded mb-2">
    <div id="colorSelectContainer" class="flex justify-center flex-wrap gap-2 mb-4">
  <input type="hidden" id="loginColor" />
  <script>
    const colorContainer = document.getElementById("colorSelectContainer");
    const hiddenColorInput = document.getElementById("loginColor");
    const colorOptions = [
      { color: "#fca5a5", label: "Soft Red" },
      { color: "#fdba74", label: "Soft Orange" },
      { color: "#fde68a", label: "Soft Yellow" },
      { color: "#bbf7d0", label: "Soft Green" },
      { color: "#bfdbfe", label: "Soft Blue" },
      { color: "#ddd6fe", label: "Soft Purple" }
    ];

    onValue(playersRef, (snapshot) => {
  const takenColors = new Set();
  const playersData = snapshot.val();
  if (playersData) {
    Object.values(playersData).forEach(player => takenColors.add(player.color));
  }

  colorOptions.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "w-10 h-10 rounded-full border-2 border-gray-300 hover:scale-105 transition-transform disabled:opacity-40 disabled:cursor-not-allowed relative flex items-center justify-center";
    btn.style.backgroundColor = opt.color;
    btn.title = opt.label;
    if (takenColors.has(opt.color)) btn.disabled = true;

    btn.onclick = (e) => {
      e.preventDefault();
      if (btn.disabled) return;
      hiddenColorInput.value = opt.color;
      document.querySelectorAll("#colorSelectContainer button").forEach(b => {
        b.classList.remove("ring-4", "ring-offset-2", "ring-gray-500");
        const checkIcon = b.querySelector(".checkmark");
        if (checkIcon) checkIcon.remove();
      });
      btn.classList.add("ring-4", "ring-offset-2", "ring-gray-500");
      const check = document.createElement("span");
      check.className = "checkmark absolute text-white text-sm";
      check.textContent = "✔";
      btn.appendChild(check);
    };
    colorContainer.appendChild(btn);
  });
});
  </script>
</div>
    <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Join</button>
  </div>

  <!-- ADMIN LOGIN -->
  

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden bg-white p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-4">Who's Up</h1>
    <div id="currentNextUpBox" class="border border-gray-300 p-2 rounded mb-4">
      Next: <span id="currentNextUp" class="font-semibold">No one</span>
    </div>
    <div class="mb-4 hidden flex-col gap-2" id="selfToggle">
      <button id="inBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" onclick="setRotationStatus('in')">In Rotation</button>
      <button id="skipBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600" onclick="setRotationStatus('skip')">Skip Me</button>
      <button id="outBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" onclick="setRotationStatus('out')">Out of Rotation</button>
    </div>
    <div>
      <h2 class="font-semibold text-left">Player Queue:</h2>
      <div id="players" class="space-y-2 text-left"></div>
    </div>
    <div class="mt-4 space-x-2">
      <button onclick="() => { localStorage.clear(); location.reload(); }" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Log Out</button>
    </div>
    <div class="mt-6 text-left">
      <h2 class="font-semibold">Out of Rotation:</h2>
      <div id="outPlayers" class="space-y-2 mt-2"></div>
    </div>
  </div>
</body>
</html>
