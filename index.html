<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Who's Up App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js"></script>
  <script>
    const { initializeApp } = firebase;
    const { getDatabase, ref, onValue, set, update } = firebase.database;

    const firebaseConfig = {
      apiKey: "AIzaSyDkEKUzUhc-nKFLnF1w0MOm6qwpKHTpfaI",
      authDomain: "who-s-up-app.firebaseapp.com",
      databaseURL: "https://who-s-up-app-default-rtdb.firebaseio.com",
      projectId: "who-s-up-app",
      storageBucket: "who-s-up-app.appspot.com",
      messagingSenderId: "167292375113",
      appId: "1:167292375113:web:ce718a1aab4852fe5daf98",
      measurementId: "G-NPK2KV2CXY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentRoom = null;
    let playersRef;
    let loggedInUser = JSON.parse(localStorage.getItem("currentUser")) || null;

    function logout() {
      localStorage.clear();
      location.reload();
    }

    function selectRoom(roomCode) {
      currentRoom = roomCode;
      playersRef = ref(db, `rooms/${roomCode}/players`);
      document.getElementById("roleSelectScreen").classList.add("hidden");
      document.getElementById("loginScreen").classList.remove("hidden");

      onValue(playersRef, (snapshot) => {
        const playersData = snapshot.val();
        updateDisplay(playersData);
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").addEventListener("click", () => {
        const nameInput = document.getElementById("loginName").value.trim();
        const color = document.getElementById("loginColor").value;

        if (!nameInput || !color) {
          alert("Please enter your name and select a color.");
          return;
        }

        const capitalized = nameInput.charAt(0).toUpperCase() + nameInput.slice(1);
        const newPlayer = { name: capitalized, color: color, active: true, skip: false };

        set(ref(db, `rooms/${currentRoom}/players/${capitalized}`), newPlayer);
        loggedInUser = newPlayer;
        localStorage.setItem("currentUser", JSON.stringify(newPlayer));

        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        document.getElementById("selfToggle").classList.remove("hidden");

        const emoji = ['tia', 'veronica', 'ella'].includes(capitalized.toLowerCase()) ? '♡' : '!';
        const welcome = document.createElement("div");
        welcome.className = "text-lg font-semibold text-green-700 mb-2";
        welcome.textContent = `Welcome, ${capitalized} ${emoji}`;
        document.getElementById("mainApp").prepend(welcome);

        onValue(playersRef, (snapshot) => {
          const playersData = snapshot.val();
          updateDisplay(playersData);
        });
      });
    });

    function setRotationStatus(status) {
      const userRef = ref(db, `rooms/${currentRoom}/players/${loggedInUser.name}`);
      if (status === 'in') {
        update(userRef, { active: true, skip: false });
      } else if (status === 'out') {
        update(userRef, { active: false, skip: false });
      } else if (status === 'skip') {
        update(userRef, { skip: true });
      }
    }

    function updateDisplay(playersObj) {
      const players = Object.values(playersObj || {}).filter(p => p.active);
      const nextPlayer = players[0]?.name || null;
      const outPlayers = Object.values(playersObj || {}).filter(p => !p.active);
      document.getElementById("players").innerHTML = "";

      if (loggedInUser?.name) {
        const pos = players.findIndex(p => p.name === loggedInUser.name);
        const container = document.createElement("div");
        container.className = "text-sm text-gray-700";
        container.innerHTML = pos !== -1
          ? `<p class="font-medium">${pos === 0 ? "You're up next!" : `You’re up in ${pos} turn(s)`}</p>`
          : `<p class="text-red-500 font-medium">You are currently out of rotation.</p>`;
        document.getElementById("players").appendChild(container);
      }

      document.getElementById("currentNextUp").textContent = nextPlayer || "No one";
      const isUp = loggedInUser?.name === nextPlayer;
      const nextBox = document.getElementById("currentNextUpBox");
      nextBox.style.borderColor = isUp ? "#22c55e" : "#d1d5db";
      nextBox.classList.remove("animate-pop");
      if (isUp) {
        void nextBox.offsetWidth;
        nextBox.classList.add("animate-pop");
      }

      const outPlayersDiv = document.getElementById("outPlayers");
      outPlayersDiv.innerHTML = "";
      outPlayers.forEach(player => {
        const div = document.createElement("div");
        div.className = "flex items-center space-x-4 p-2 rounded";
        div.style.backgroundColor = player.color;
        div.innerHTML = `
          <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color: ${player.color}">
            ${player.name.charAt(0)}
          </div>
          <span>${player.name}</span>
        `;
        outPlayersDiv.appendChild(div);
      });
    }
  </script>
  <style>
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
    .animate-pop { animation: pop 0.5s ease-in-out; }
  </style>
</head>
<body class="bg-gray-100 flex justify-center items-start min-h-screen py-10">
  <div id="roleSelectScreen" class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-4">Who's Up App</h1>
    <p class="mb-2">Select your room</p>
    <div class="flex gap-4 justify-center mb-4">
      <button onclick="selectRoom('BH')" class="bg-blue-500 text-white px-4 py-2 rounded">Join BH</button>
      <button onclick="selectRoom('59')" class="bg-purple-500 text-white px-4 py-2 rounded">Join 59</button>
    </div>
  </div>
  <div id="loginScreen" class="hidden bg-white p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-4">Join Who's Up</h1>
    <input id="loginName" type="text" placeholder="Your name" class="w-full p-2 border border-gray-300 rounded mb-2">
    <input type="hidden" id="loginColor">
    <div id="colorSelectContainer" class="flex justify-center flex-wrap gap-2 mb-4"></div>
    <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Join</button>
  </div>
  <div id="mainApp" class="hidden bg-white p-6 rounded-lg shadow-lg w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-4">Who's Up</h1>
    <div id="currentNextUpBox" class="border border-gray-300 p-2 rounded mb-4">
      Next: <span id="currentNextUp" class="font-semibold">No one</span>
    </div>
    <div class="mb-4 hidden flex-col gap-2" id="selfToggle">
      <button id="inBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" onclick="setRotationStatus('in')">In Rotation</button>
      <button id="skipBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600" onclick="setRotationStatus('skip')">Skip Me</button>
      <button id="outBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" onclick="setRotationStatus('out')">Out of Rotation</button>
    </div>
    <div>
      <h2 class="font-semibold text-left">Player Queue:</h2>
      <div id="players" class="space-y-2 text-left"></div>
    </div>
    <div class="mt-4 space-x-2">
      <button onclick="logout()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Log Out</button>
    </div>
    <div class="mt-6 text-left">
      <h2 class="font-semibold">Out of Rotation:</h2>
      <div id="outPlayers" class="space-y-2 mt-2"></div>
    </div>
  </div>
</body>
</html>
