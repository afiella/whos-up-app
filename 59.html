<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>59 Room</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase (v8.x) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4" data-room="59">

  <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-lg flex flex-col justify-between min-h-[90vh]">
    <!-- Name Select Section -->
    <div id="nameSelect">
      <p class="text-center mb-2">Select Your Name</p>
      <div id="nameButtons" class="flex flex-wrap gap-3 justify-center mb-4"></div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="hidden flex-grow flex flex-col justify-between">
      <div>
        <div class="text-center mb-4">
          <p id="joinedMessage" class="text-green-600 font-medium"></p>
        </div>

        <div class="text-center mb-4">
          <div id="nextUp" class="font-bold text-blue-600"></div>
        </div>

        <!-- Player Queues -->
        <div id="queue">
          <h2 class="text-lg font-semibold text-green-700 mb-2">Active Players:</h2>
          <div id="activePlayers" class="space-y-1 mb-6"></div>

          <h2 class="text-lg font-semibold text-yellow-600 mb-2">With Customer:</h2>
          <div id="skipPlayers" class="space-y-1 mb-6"></div>

          <h2 class="text-lg font-semibold text-red-600 mb-2">Out of Rotation:</h2>
          <div id="outPlayers" class="space-y-1 mb-6"></div>
        </div>
      </div>

      <!-- Bottom Action Buttons -->
      <div class="mt-6 pt-6 border-t border-gray-200">
        <div class="flex justify-center gap-3 mb-4">
          <button onclick="setStatus('active')" class="bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600">In</button>
          <button onclick="setStatus('skip')" class="bg-yellow-500 text-white px-4 py-2 rounded-full hover:bg-yellow-600">With Customer</button>
          <button onclick="setStatus('inactive')" class="bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600">Out</button>
        </div>
        <div class="text-center">
          <button onclick="leaveGame()" class="text-sm text-gray-600 underline">Leave Game</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inline Script for Room Logic -->
  <script>
    // ---------------------------------------------------------
    // 1) Initialize Firebase (v8 Syntax)
    //    Paste in your real Firebase config below
    // ---------------------------------------------------------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);

    // Grab a reference to the Database
    const db = firebase.database();

    // ---------------------------------------------------------
    // 2) DOM references
    // ---------------------------------------------------------
    let currentName = null; // the name of the current user
    const room            = document.body.getAttribute("data-room") || "59";
    const nameSelectEl    = document.getElementById("nameSelect");
    const mainScreenEl    = document.getElementById("mainScreen");
    const nameButtonsEl   = document.getElementById("nameButtons");
    const joinedMessageEl = document.getElementById("joinedMessage");
    const nextUpEl        = document.getElementById("nextUp");
    const activePlayersEl = document.getElementById("activePlayers");
    const skipPlayersEl   = document.getElementById("skipPlayers");
    const outPlayersEl    = document.getElementById("outPlayers");

    // ---------------------------------------------------------
    // 3) Populate name buttons (Example: 5 fixed names)
    // ---------------------------------------------------------
    function populateNameButtons() {
      const possibleNames = ["Alice", "Bob", "Carol", "Dan", "Eve"];
      possibleNames.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.className = "bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600";
        btn.addEventListener("click", () => joinGame(name));
        nameButtonsEl.appendChild(btn);
      });
    }

    // ---------------------------------------------------------
    // 4) Join game under a selected name
    // ---------------------------------------------------------
    function joinGame(name) {
      currentName = name;
      const playerRef = db.ref(`rooms/${room}/players/${currentName}`);

      playerRef.set({
        name: currentName,
        active: true,
        skip: false,
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        color: getRandomColor() // Optional: random color
      });

      // Switch the UI
      nameSelectEl.classList.add("hidden");
      mainScreenEl.classList.remove("hidden");
      joinedMessageEl.textContent = `You have joined as ${currentName}!`;
    }

    // ---------------------------------------------------------
    // 5) Listen to changes in room data
    // ---------------------------------------------------------
    function listenToRoom(roomKey) {
      const refPlayers = db.ref(`rooms/${roomKey}/players`);
      refPlayers.on("value", (snapshot) => {
        const data = snapshot.val() || {};
        updateUI(data);
      });
    }

    // ---------------------------------------------------------
    // 6) Update the UI each time data changes
    // ---------------------------------------------------------
    function updateUI(playersData) {
      // Clear existing lists
      activePlayersEl.innerHTML = "";
      skipPlayersEl.innerHTML   = "";
      outPlayersEl.innerHTML    = "";
      nextUpEl.textContent      = "";

      // Convert object to array, sort by joinedAt
      const entries = Object.entries(playersData).sort((a, b) => a[1].joinedAt - b[1].joinedAt);

      // Who is next up?
      const firstActive = entries.find(([_, p]) => p.active && !p.skip);
      if (firstActive) {
        nextUpEl.textContent = `Next Up: ${firstActive[0]}`;
      }

      // Populate each list
      entries.forEach(([playerKey, player]) => {
        const div = document.createElement("div");
        div.textContent = player.name;
        div.className = "border px-2 py-1 rounded";

        if (player.active && !player.skip) {
          activePlayersEl.appendChild(div);
        } else if (player.active && player.skip) {
          skipPlayersEl.appendChild(div);
        } else {
          outPlayersEl.appendChild(div);
        }
      });
    }

    // ---------------------------------------------------------
    // 7) Set player status: "active" / "skip" / "inactive"
    // ---------------------------------------------------------
    window.setStatus = function(status) {
      if (!currentName) {
        alert("You have not joined the game.");
        return;
      }
      const playerRef = db.ref(`rooms/${room}/players/${currentName}`);
      if (status === "active") {
        playerRef.update({ active: true, skip: false, joinedAt: firebase.database.ServerValue.TIMESTAMP });
      } else if (status === "skip") {
        playerRef.update({ active: true, skip: true, joinedAt: firebase.database.ServerValue.TIMESTAMP });
      } else {
        // 'inactive'
        playerRef.update({ active: false, skip: false });
      }
    };

    // ---------------------------------------------------------
    // 8) Leave the game (removes you from DB or set inactive)
    // ---------------------------------------------------------
    window.leaveGame = function() {
      if (!currentName) return;
      const playerRef = db.ref(`rooms/${room}/players/${currentName}`);
      playerRef.remove();

      // Switch UI
      currentName = null;
      nameSelectEl.classList.remove("hidden");
      mainScreenEl.classList.add("hidden");
      joinedMessageEl.textContent = "";
      nextUpEl.textContent = "";
    };

    // ---------------------------------------------------------
    // 9) Helper: get random color (optional)
    // ---------------------------------------------------------
    function getRandomColor() {
      const letters = "0123456789ABCDEF";
      let color = "#";
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    // ---------------------------------------------------------
    // 10) On page load, set up name buttons & start listening
    // ---------------------------------------------------------
    window.addEventListener("DOMContentLoaded", () => {
      populateNameButtons();
      listenToRoom(room);
    });
  </script>
</body>
</html>
